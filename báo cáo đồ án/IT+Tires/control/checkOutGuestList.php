<div class="content" style="margin-top: 0px;">
<div class="header">
<div class="defaultTitle">
Đặt hàng và thanh toán
</div>
</div>

<div class="content_partition1" style="margin-left: -2px">

<form action="#" method="post" enctype="multipart/form-data">
<div class="content_part1">
	<div style="width: 560px; border: 1px solid #ccc; padding: 5px 5px; color: #a80002; font-weight: bold;">Thông tin thanh toán và giao nhận hàng</div>
    <div style="width: 548px; margin-top: 10px; font-weight: bold; padding: 0px 6px;">Thông tin thanh toán</div>
    <div style="width: 560px; margin-top: 10px; text-align: left;">
		<table border="0" cellpadding="2" cellspacing="2">
            <tr>
            <td align="right">Email <font style="color: #F00">(*)</font>: </td>
            <td><input type="text" name="email" id="email" style="width: 330px; border: 1px solid #ccc;"/></td>
            </tr>
            <tr>
            <td align="right">Họ và Tên <font style="color: #F00">(*)</font>: </td>
            <td><input type="text" name="name" id="name" style="width: 330px; border: 1px solid #ccc;"/></td>
            </tr>
            <tr>
            <td align="right">Điện thoại <font style="color: #F00">(*)</font>: </td>
            <td><input type="text" name="tel" id="tel" style="width: 330px; border: 1px solid #ccc;"/></td>
            </tr>
            <tr>
            <td align="right">Địa chỉ <font style="color: #F00">(*)</font>: </td>
            <td><input type="text" name="address" id="address" style="width: 330px; border: 1px solid #ccc;"/></td>
            </tr>
    <tr>
    <td align="right"> Tỉnh / Thành phố <font style="color: #F00">(*)</font>: </td>
    <td>
    <select name="country" id="country" style="width: 220px; border: 1px solid #ccc;">
    <option value=""></option>
    	<option value="Hà Nội">Hà Nội</option>
		<option value="Hồ Chí Minh">Hồ Chí Minh</option>
		<option value="Đà Nẵng">Đà Nẵng</option>
		<option value="Cần Thơ">Cần Thơ</option>
		<option value="An Giang">An Giang</option>
		<option value="Bà Rịa - Vũng Tàu">Bà Rịa - Vũng Tàu</option>
		<option value="Bắc Giang">Bắc Giang</option>
		<option value="Bắc Kạn">Bắc Kạn</option>
		<option value="Bạc Liêu">Bạc Liêu</option>
		<option value="Bắc Ninh">Bắc Ninh</option>
		<option value="Bến Tre">Bến Tre</option>
		<option value="Bình Định">Bình Định</option>
		<option value="Bình Dương">Bình Dương</option>
		<option value="Bình Phước">Bình Phước</option>
		<option value="Bình Thuận">Bình Thuận</option>
		<option value="Cà Mau">Cà Mau</option>
		<option value="Cao Bằng">Cao Bằng</option>
		<option value="Đăk Lăk">Đăk Lăk</option>
		<option value="Đăk Nông">Đăk Nông</option>
		<option value="Điện Biên">Điện Biên</option>
		<option value="Đồng Nai">Đồng Nai</option>
		<option value="Đồng Tháp">Đồng Tháp</option>
		<option value="Gia Lai">Gia Lai</option>
		<option value="Hà Giang">Hà Giang</option>
		<option value="Hà Nam">Hà Nam</option>
		<option value="Hà Tĩnh">Hà Tĩnh</option>
		<option value="Hải Dương">Hải Dương</option>
		<option value="Hải Phòng">Hải Phòng</option>
		<option value="Hậu Giang">Hậu Giang</option>
		<option value="Hòa Bình">Hòa Bình</option>
		<option value="Huế">Huế</option>
		<option value="Hưng Yên">Hưng Yên</option>
		<option value="Khánh Hòa">Khánh Hòa</option>
		<option value="Kiên Giang">Kiên Giang</option>
		<option value="Kon Tum">Kon Tum</option>
		<option value="Lai Châu">Lai Châu</option>
		<option value="Lâm Đồng">Lâm Đồng</option>
		<option value="Lạng Sơn">Lạng Sơn</option>
		<option value="Lào Cai">Lào Cai</option>
		<option value="Long An">Long An</option>
		<option value="Nam Định">Nam Định</option>
		<option value="Nghệ An">Nghệ An</option>
		<option value="Ninh Bình">Ninh Bình</option>
		<option value="Ninh Thuận">Ninh Thuận</option>
		<option value="Phú Thọ">Phú Thọ</option>
		<option value="Phú Yên">Phú Yên</option>
		<option value="Quảng Bình">Quảng Bình</option>
		<option value="Quảng Nam">Quảng Nam</option>
		<option value="Quảng Ngãi">Quảng Ngãi</option>
		<option value="Quảng Ninh">Quảng Ninh</option>
		<option value="Quảng Trị">Quảng Trị</option>
		<option value="Sóc Trăng">Sóc Trăng</option>
		<option value="Sơn La">Sơn La</option>
		<option value="Tây Ninh">Tây Ninh</option>
		<option value="Thái Bình">Thái Bình</option>
		<option value="Thái Nguyên">Thái Nguyên</option>
		<option value="Thanh Hóa">Thanh Hóa</option>
		<option value="Tiền Giang">Tiền Giang</option>
		<option value="Trà Vinh">Trà Vinh</option>
		<option value="Tuyên Quang">Tuyên Quang</option>
		<option value="Vĩnh Long">Vĩnh Long</option>
		<option value="Vĩnh Phúc">Vĩnh Phúc</option>
		<option value="Yên Bái">Yên Bái</option>  
    </select>
    </td>
    </tr>
    	</table>
    
    </div>
    <div style="margin-top: 5px; border-top: 1px solid #ccc;"></div>
    <div style="width: 548px; margin-top: 10px; font-weight: bold; padding: 0px 6px;">Địa chỉ nhận hàng</div>
    <div style="width: 560px; margin-top: 10px; text-align: left;">
    
		<table border="0" cellpadding="2" cellspacing="2">
            <tr>
            <td align="right">Họ và Tên <font style="color: #F00">(*)</font>: </td>
            <td><input type="text" name="nameRec" id="nameRec" style="width: 330px; border: 1px solid #ccc;"/></td>
            </tr>
            <tr>
            <td align="right">Điện thoại <font style="color: #F00">(*)</font>: </td>
            <td><input type="text" name="telRec" id="telRec" style="width: 330px; border: 1px solid #ccc;"/></td>
            </tr>
            <tr>
            <td align="right">Địa chỉ <font style="color: #F00">(*)</font>: </td>
            <td><input type="text" name="addressRec" id="addressRec" style="width: 330px; border: 1px solid #ccc;"/></td>
            </tr>
    <tr>
    <td align="right"> Tỉnh / Thành phố <font style="color: #F00">(*)</font>: </td>
    <td>
    <select name="countryRec" id="countryRec" style="width: 220px; border: 1px solid #ccc;">
    <option value=""></option>
    	<option value="Hà Nội">Hà Nội</option>
		<option value="Hồ Chí Minh">Hồ Chí Minh</option>
		<option value="Đà Nẵng">Đà Nẵng</option>
		<option value="Cần Thơ">Cần Thơ</option>
		<option value="An Giang">An Giang</option>
		<option value="Bà Rịa - Vũng Tàu">Bà Rịa - Vũng Tàu</option>
		<option value="Bắc Giang">Bắc Giang</option>
		<option value="Bắc Kạn">Bắc Kạn</option>
		<option value="Bạc Liêu">Bạc Liêu</option>
		<option value="Bắc Ninh">Bắc Ninh</option>
		<option value="Bến Tre">Bến Tre</option>
		<option value="Bình Định">Bình Định</option>
		<option value="Bình Dương">Bình Dương</option>
		<option value="Bình Phước">Bình Phước</option>
		<option value="Bình Thuận">Bình Thuận</option>
		<option value="Cà Mau">Cà Mau</option>
		<option value="Cao Bằng">Cao Bằng</option>
		<option value="Đăk Lăk">Đăk Lăk</option>
		<option value="Đăk Nông">Đăk Nông</option>
		<option value="Điện Biên">Điện Biên</option>
		<option value="Đồng Nai">Đồng Nai</option>
		<option value="Đồng Tháp">Đồng Tháp</option>
		<option value="Gia Lai">Gia Lai</option>
		<option value="Hà Giang">Hà Giang</option>
		<option value="Hà Nam">Hà Nam</option>
		<option value="Hà Tĩnh">Hà Tĩnh</option>
		<option value="Hải Dương">Hải Dương</option>
		<option value="Hải Phòng">Hải Phòng</option>
		<option value="Hậu Giang">Hậu Giang</option>
		<option value="Hòa Bình">Hòa Bình</option>
		<option value="Huế">Huế</option>
		<option value="Hưng Yên">Hưng Yên</option>
		<option value="Khánh Hòa">Khánh Hòa</option>
		<option value="Kiên Giang">Kiên Giang</option>
		<option value="Kon Tum">Kon Tum</option>
		<option value="Lai Châu">Lai Châu</option>
		<option value="Lâm Đồng">Lâm Đồng</option>
		<option value="Lạng Sơn">Lạng Sơn</option>
		<option value="Lào Cai">Lào Cai</option>
		<option value="Long An">Long An</option>
		<option value="Nam Định">Nam Định</option>
		<option value="Nghệ An">Nghệ An</option>
		<option value="Ninh Bình">Ninh Bình</option>
		<option value="Ninh Thuận">Ninh Thuận</option>
		<option value="Phú Thọ">Phú Thọ</option>
		<option value="Phú Yên">Phú Yên</option>
		<option value="Quảng Bình">Quảng Bình</option>
		<option value="Quảng Nam">Quảng Nam</option>
		<option value="Quảng Ngãi">Quảng Ngãi</option>
		<option value="Quảng Ninh">Quảng Ninh</option>
		<option value="Quảng Trị">Quảng Trị</option>
		<option value="Sóc Trăng">Sóc Trăng</option>
		<option value="Sơn La">Sơn La</option>
		<option value="Tây Ninh">Tây Ninh</option>
		<option value="Thái Bình">Thái Bình</option>
		<option value="Thái Nguyên">Thái Nguyên</option>
		<option value="Thanh Hóa">Thanh Hóa</option>
		<option value="Tiền Giang">Tiền Giang</option>
		<option value="Trà Vinh">Trà Vinh</option>
		<option value="Tuyên Quang">Tuyên Quang</option>
		<option value="Vĩnh Long">Vĩnh Long</option>
		<option value="Vĩnh Phúc">Vĩnh Phúc</option>
		<option value="Yên Bái">Yên Bái</option>  
    </select>
    </td>
    </tr>
    	</table>
    
    </div>
    <div style="margin-top: 5px; border-top: 1px solid #ccc;"></div>
    <div style="width: 548px; margin-top: 10px; font-weight: bold; padding: 0px 6px;">Hình thức thanh toán</div>
    <div style="width: 560px; margin-top: 10px; text-align: left;">
        <input type="radio" name="paymentForm" id="paymentForm" value="1"/>Thanh toán tại các đại lý phân phối sản phẩm</div>
   	<div style="width: 560px; margin-top: 5px; text-align: left;">
        <input type="radio" name="paymentForm" id="paymentForm" value="2"/>Thanh toán khi nhận được hàng
    </div>  
    <div style="width: 560px; margin-top: 5px; text-align: left;">
        <input type="radio" name="paymentForm" id="paymentForm" value="3"/>Thanh toán trực tuyến an toàn qua NgânLượng.vn
    </div>
    <div style="margin-top: 5px; border-top: 1px solid #ccc;"></div>
    <div style="width: 548px; margin-top: 10px; font-weight: bold; padding: 0px 6px;">Hình thức vận chuyển đơn hàng
    </div>
    <div style="width: 560px; margin-top: 10px; text-align: left;">
    <label>
    	<input type="radio" name="paymentShip" id="paymentShip" value="1" checked="checked" /> Miễn phí trong phạm vi 10 Km (Trong ngày)
    </label>
    </div>
    <div style="width: 572px; margin-top: 10px; text-align: left;">
    	<table width="572px" border="1" cellpadding="2" cellspacing="2" class="csstable1">
			<tr>
            	<th scope="col">STT</th>
                <th scope="col">ID</th>
                <th scope="col">Sản phẩm</th>
                <th scope="col">Giá bán</th>
                <th scope="col">Số lượng</th>
                <th scope="col">Tổng</th>
            </tr>
            <?php
				$i=0;
				$totalBill=0;
				$_SESSION['totalBill']=$totalBill;
			if(isset($_SESSION['purchase']))
			{
				foreach($_SESSION['purchase'] as $item)
				{
					$i++;
					$result=mysql_query("SELECT * FROM products WHERE id=".$item[0]);
					if($result)
					{
						$row=mysql_fetch_array($result);
						$_SESSION['priceGuest']=$row['price'];
						$totalPrice=$row['price']*$item[1];
						$_SESSION['totalPriceGuest']=$totalPrice;
						$totalBill+=$totalPrice;
						//$_SESSION['totalBillGuest']=$totalBill;
					}
			?>
			<tr>
				<td>
					<?php
						echo $i;
						$_SESSION['numberPro']=$i;
					?>
				</td>
				<td>
					<?php
						echo $item[0];
					?>
				</td>
				<td>
					<?php
						echo '<a href="productDetail.php?pid='.$row['id'].'"><b>'.$row['name'].'</b></a>';
					?>
				</td>
				<td>
					<?php
						echo number_format($row['price']).' <u>VND</u>';
					?>
				</td>
				<td>
					<?php echo $item[1]; ?>
				</td>
				<td>
					<?php
						echo '<b>'.number_format($totalPrice).' <u>VND</u></b>';
					?>
				</td>
			</tr>
			<?php
				}
			}
			?>
            <tr>
                <td colspan="6" align="right">
                    <?php
                        echo '<b>Tổng tiền:</b>';
                        echo '<font style="color: #a80002; font-weight: bold;"> '.number_format($totalBill).' <u>VND</u></font> (Chưa tính phí vận chuyển)';
                    ?>
                </td>
            </tr>
       	</table>
    </div>
    <div style="width: 548px; margin-top: 10px; font-weight: bold; padding: 0px 6px;">Lời nhắn <font style="font-weight: normal">(Gửi thông điệp của bạn để chúng tôi có thể phục vụ bạn tốt hơn)</font></div>
    <div style="width: 560px; margin-top: 5px; text-align: left;">
        <textarea name="note" id="note" style="width: 566px; height: 60px;"></textarea>
    </div> 
    <div style="width: 566px; margin-top: 5px; text-align: right;">
    	<input type="button" name="btnBack" id="btnBack" value="Quay lại"  onclick="window.location='checkOut.php'"/>
        <input type="submit" name="btnOrder" id="btnOrder" value="Xác nhận và gửi đơn hàng" />
    </div>
    
    </form>
</div>
</div>

</div>


<?php
	if(isset($_POST['btnOrder']))
	{
		$sql="INSERT INTO users(name,address,country,tel,email,date,Role) VALUES('".$_POST['name']."','".$_POST['address']."','".$_POST['country']."','".$_POST['tel']."','".$_POST['email']."',NOW(),3)";
		$query=mysql_query($sql,$link);

		$sql1="SELECT * FROM users WHERE email='".$_POST['email']."' ORDER BY id DESC limit 0,1";
		$query1=mysql_query($sql1,$link);
		$row1=mysql_fetch_array($query1);
		$_SESSION['idGuest']=$row1['id'];
		$_SESSION['emailGuest']=$row1['email'];
		
		$sql2="INSERT INTO orders(cusID,orderDate,paymentForm,paymentShip,recipient,address,tel,country,email,totalBill,note,status) VALUES('".$row1['id']."',NOW(),'".$_POST['paymentForm']."','".$_POST['paymentShip']."','".$_POST['nameRec']."','".$_POST['addressRec']."','".$_POST['telRec']."','".$_POST['countryRec']."','".$row1['email']."','".$totalBill."','".$_POST['note']."',0)";
		$query2=mysql_query($sql2,$link);
		$row2=mysql_fetch_array($query2);
		
		$sql3="SELECT * FROM orders WHERE cusID='".$row1['id']."' ORDER BY id DESC limit 0,1";
		$query3=mysql_query($sql3,$link);
		$row3=mysql_fetch_array($query3);
		$_SESSION['idOrderGuest']=$row3['id'];
				
		foreach($_SESSION['purchase'] as $item)
		{	
			$query5=mysql_query("SELECT * FROM products WHERE id='".$item[0]."'");
			while($row5=mysql_fetch_array($query5))
			{
				$totalPriceGuest=$row5['price'].$item[1];
				$sql4="INSERT INTO orderdetails(orderID,proID,price,amount,totalPrice) VALUES('".$row3['id']."','".$item[0]."','".$row5['price']."','".$item[1]."','".$totalPriceGuest."')";
				$query4=mysql_query($sql4,$link);
				if($query4)
				{
					header('Location: orderCompleted.php');
				}
				else
				{
					echo '<h3><font style="color: #FF000B;">Đơn hàng bị lỗi. Vui lòng thử lại sau</font></h3>';	
				}
			}
		}
	}
?>






